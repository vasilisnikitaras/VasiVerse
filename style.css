console.log("✅ VasiVerse Weather Script Loaded");

const apiKey = "bd1a2e25b5af86632c1c461148512426";
let debugMode = false; // 🐛 Toggle with "D" key

// 🔑 Debug Mode Toggle (Global Listener)
window.addEventListener("keydown", e => {
  if (e.key.toLowerCase() === "d") {
    debugMode = !debugMode;
    showToast(debugMode ? "🐛 Debug Mode: ON" : "🧼 Debug Mode: OFF");
    if (debugMode) console.clear();
  }
});

// 🌙 Dark Mode on Load
if (localStorage.getItem("darkMode") === "enabled") {
  document.body.classList.add("dark-mode");
}

// === DOM Ready ===
document.addEventListener("DOMContentLoaded", () => {
  const toggleBtn = document.getElementById("dark-mode-toggle");
  const backToTopButton = document.getElementById("back-to-top");
  const searchBtn = document.getElementById("search-btn");

  // 🌙 Dark Mode Toggle
  if (toggleBtn) {
    toggleBtn.addEventListener("click", () => {
      const isDark = document.body.classList.toggle("dark-mode");
      localStorage.setItem("darkMode", isDark ? "enabled" : "disabled");
      showToast(isDark ? "🌙 Dark Mode Enabled" : "☀️ Light Mode Enabled");
    });
  }

  // 🔍 City Forecast Search
  if (searchBtn) {
    searchBtn.addEventListener("click", () => {
      const cityInput = document.getElementById("city-input");
      const output = document.getElementById("weather-output");
      const container = document.getElementById("forecast-container");
      if (!cityInput || !output || !container) return;

      const city = cityInput.value.trim();
      if (!city) {
        output.textContent = "Please enter a city name.";
        return;
      }

      output.innerHTML = `🌩️ Loading forecast for <strong>${city}</strong>...`;
      container.innerHTML = "";
      fetchWeatherByCity(city);
    });
  }

  // ⬆️ Back to Top Button
  if (backToTopButton) {
    backToTopButton.addEventListener("click", () =>
      window.scrollTo({ top: 0, behavior: "smooth" })
    );
    window.addEventListener("scroll", () => {
      backToTopButton.classList.toggle("visible", window.scrollY > 400);
    });
  }

  // 🧭 Smooth Scroll
  document.querySelectorAll("nav a[href^='#']").forEach(link => {
    link.addEventListener("click", e => {
      e.preventDefault();
      const target = document.querySelector(link.getAttribute("href"));
      if (target) target.scrollIntoView({ behavior: "smooth" });
    });
  });
});

// 🔔 Toast Messages
function showToast(message) {
  const old = document.querySelector(".vasiverse-toast");
  if (old) old.remove();
  const toast = document.createElement("div");
  toast.className = "vasiverse-toast";
  toast.textContent = message;
  Object.assign(toast.style, {
    position: "fixed",
    bottom: "20px",
    left: "50%",
    transform: "translateX(-50%)",
    background: "rgba(0, 0, 0, 0.8)",
    color: "#fff",
    padding: "8px 14px",
    borderRadius: "6px",
    fontSize: "14px",
    zIndex: "9999",
    opacity: "0",
    transition: "opacity 0.3s ease"
  });
  document.body.appendChild(toast);
  requestAnimationFrame(() => (toast.style.opacity = "1"));
  setTimeout(() => {
    toast.style.opacity = "0";
    toast.addEventListener("transitionend", () => toast.remove());
  }, 3000);
}

// 🌇 Auto-Fetch on Page Load
window.onload = () => {
  const container = document.getElementById("forecast-container");
  if (!container) return console.warn("Missing #forecast-container");

  container.innerHTML = "🌩️ Loading local forecast...";
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        const { latitude, longitude } = pos.coords;
        if (debugMode) console.log("🔍 Location:", latitude, longitude);
        fetchWeatherByCoords(latitude, longitude);
      },
      err => {
        if (debugMode) console.warn("Geolocation error:", err.message);
        fetchWeatherByCity("Montreal");
      }
    );
  } else {
    fetchWeatherByCity("Montreal");
  }
};

// 📡 Fetch by Coordinates
function fetchWeatherByCoords(lat, lon) {
  const container = document.getElementById("forecast-container");
  if (container) container.innerHTML = "🌩️ Loading forecast...";

  const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&appid=${apiKey}`;
  if (debugMode) console.log("📡 Fetching:", url);

  fetch(url)
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    })
    .then(data => displayForecast(data))
    .catch(err => {
      console.error("❌ Weather API error:", err.message);
      if (container) container.textContent = "☁️ Forecast unavailable.";
    });
}

// 🏙️ Fetch by City
function fetchWeatherByCity(city) {
  const container = document.getElementById("forecast-container");
  if (container) container.innerHTML = `🌩️ Loading forecast for <strong>${city}</strong>...`;

  const url = `https://api.openweathermap.org/data/2.5/forecast?q=${city}&units=metric&appid=${apiKey}`;
  if (debugMode) console.log("🏙️ Fetching:", url);

  fetch(url)
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    })
    .then(data => displayForecast(data))
    .catch(err => {
      console.error("❌ City Weather error:", err.message);
      if (container) container.textContent = `⚠️ Could not load forecast for "${city}".`;
    });
}

// 🖼️ Render Forecast Cards
function displayForecast(data) {
  const container = document.getElementById("forecast-container");
  if (!container) return console.warn("Missing container: #forecast-container");

  if (debugMode) {
    console.log("🧪 Forecast entries:", data.list?.length);
    console.log("💾 Full forecast data:", data);
  }

  container.innerHTML = '';
  const daily = data.list.filter((_, i) => i % 8 === 0).slice(0, 5);
  if (daily.length === 0) {
    container.innerHTML = "⚠️ No forecast data available.";
    return;
  }

  daily.forEach(item => {
    const date = new Date(item.dt_txt);
    const temp = Math.round(item.main.temp);
    const icon = item.weather[0].icon;
    const condition = item.weather[0].description;
    const emoji = getWeatherEmoji(item.weather[0].main);

    container.innerHTML += `
      <div class="forecast-card">
        <p><strong>${date.toDateString()}</strong></p>
        <img src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="${condition}">
        <p>${emoji} ${condition}</p>
        <p>🌡️ ${temp}°C</p>
      </div>
    `;
  });

  if (debugMode) console.log("✅ Forecast rendered successfully");
}

// 🌈 Emoji Helper
function getWeatherEmoji(condition) {
  const c = condition.toLowerCase();
  if (c.includes("clear")) return "☀️";
  if (c.includes("cloud")) return "☁️";
  if (c.includes("rain")) return "🌧️";
  if (c.includes("snow")) return "❄️";
  if (c.includes("thunder")) return "⛈️";
  if (c.includes("drizzle")) return "🌦️";
  if (c.includes("fog") || c.includes("mist")) return "🌫️";
  return "🌡️";
}
